# Описание

Набор скриптов для автоматизации развертывания образов на базе seL4 на сервере-развертывания. Предполагается, что помимо сервера-развертывания для запуска образа в той же сети находится другой сервер-установщик, который выступает одновременно как dhcp сервер. Установка образа на сервере-развертывания выполняется методом [PXE-boot](https://wiki.debian.org/PXEBootInstall), который не требует традиционного сетевого стека для обмена файлами, а использует легковесный узконаправленный сетевой протокол для скачивания загрузчика: 

- после включения сервер-развертывания распространяет dhcp запросы в сети;
- сервер-установщик получает эти запросы и выдает IP;
- сервер-развертывания запрашивает необходимую информацию о хранилище загрузчика;
- сервер-развертывания запрашивает и скачивает минимальный загрузчик необходимый для подгрузки основного образа;
- загрузчик запускает сетевой стек и скачивает более тяжеловестный образ ядра с приложением;
- после скачивание, управление передается ядру seL4, которое после загрузки системных модулей передает управление приложению;

В качестве dhcp сервера на сервере-установщике запускается [dnsmasq](http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html), который одновременно реализует протокол PXE-boot и обеспечивает сервер-развертывания необходимыми образами для загрузки. Образ загрузчика предоставляется дистрибутивом [syslinux](https://wiki.syslinux.org/wiki/index.php?title=The_Syslinux_Project).

Весь процесс настройки сервера-установщика реализован в виде [ansible playbook](https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html). Предполагается, что скрипт запускается на сервере отличном от сервера-установщика и сервера-развертывания, назовем его - сервер-настройки.

# Требование

Работа скрипта была проверена на сервере-настройки с ОС **Ubuntu 18.04**, сервере-установщике с ОС **Fedora 32** и сервере-развертывания **Supermicro**.

# Установка "вручную"

1. Для начала работы необходимо установить ansible на сервер-настройки:

```
$ sudo apt update
$ sudo apt install software-properties-common
$ sudo apt-add-repository --yes --update ppa:ansible/ansible
$ sudo apt install ansible
```

2. Далее клонируем репозитарий со скриптом, переходим в него и создаем конфигурационный файл из шаблона:
```
cp config.yml.tpl config.yml
```

3. Далее необходимо создать в той же директории директорию *Images* и скопировать в нее файлы собранного ядра и приложения. Сборка приложения выходит за рамки работы скрипта. Более подробную информацию об этом процессе можно найти на официальном [сайте seL4](https://docs.sel4.systems/Hardware/IA32).

4. Открываем config.yml в вашем любимом текстовом редакторе и указываем имена файлов ядра (kernel) и приложения (application).

5. Генерируем [ssh ключ](https://docs.github.com/en/github/authenticating-to-github/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent) на сервере-настройки (если не генерировали до этого) и добавляем его в ~/.ssh/authorized_keys на сервере-установщике.

6. Наконец стартуем процесс настройки:
```
ansible-playbook -i Hosts/inventory.env Playbooks/server-config.yml
```

7. Перезагружаем сервер-развертывания и ожидаем процесс загрузки и развертывания ядра с приложением.

# Docker

Тем не менее конфигурация сервера-настройки "вручную" не всегда удобна. Поэтому для автоматизации этого процесса был создан Docker образ, который уже включает в себя необходимые зависимости для развертывания
приложений для seL4. Более того образ уже содержит пример простого приложения ```hello-cake```, которое можно запустить на оборудовании:

1. Скачиванием Docker образ
```
docker pull innochainver/verif:all
```

2. Генерируем [ssh ключ](https://docs.github.com/en/github/authenticating-to-github/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent) (если не генерировали до этого) и добавляем его в ```~/.ssh/authorized_keys``` на сервере-установщике. Предполагаем, что сгенерированные ключи находятся в директории ```~/.ssh```.

3. Запускаем Docker контейнер и привязываем к нему директории с сгенерированными ключами:
```
docker run -it -v ~/.ssh:/root/.ssh:ro innochainver/verif:all bash
```

4. Добавляем ssh ключ агенту:
```
ssh-agent bash
ssh-add <путь до файла с ключом>
```

5. Переходим в директорию со скриптом:
```
cd /root/sel4-deploy
```

6. Наконец стартуем процесс настройки:
```
ansible-playbook -i Hosts/inventory.env Playbooks/server-config.yml
```
